<!doctype html>
<meta charset="utf-8">
<title>BLE — Test NUS Notify</title>
<button id="btn">Conectar a ESP32 (NUS)</button>
<div id="last">—</div>
<pre id="log"></pre>
<script>
const SVC = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const TX  = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
const $ = id => document.getElementById(id);
const log = m => ($("log").textContent += m + "\n");
$("btn").onclick = async () => {
  try {
    log("Buscando…");
    const dev = await navigator.bluetooth.requestDevice({
      filters:[{namePrefix:"ESP32"}],
      optionalServices:[SVC]
    });
    log("Elegido: " + (dev.name||"(sin nombre)"));
    dev.addEventListener("gattserverdisconnected",()=>log("⚠️ Desconectado"));
    const server = await dev.gatt.connect();
    log("Conectado");
    const svc = await server.getPrimaryService(SVC);
    const tx  = await svc.getCharacteristic(TX);
    await tx.startNotifications();
    tx.addEventListener("characteristicvaluechanged", e => {
      const txt = new TextDecoder().decode(e.target.value).trim();
      $("last").textContent = txt;
      log("RX: " + txt);
    });
    log("Suscrito a TX (notify). Esperando datos…");
  } catch (e) {
    log("ERROR: " + e);
  }
};
</script>
