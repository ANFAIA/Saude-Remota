<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>RemotaSa√∫de ‚Äì Datos BLE</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    h1 { color: #333; }
    button { padding: 10px 15px; margin: 5px; }
    #log { background: #eee; padding: 10px; height: 200px; overflow-y: auto; }
    #data { font-size: 18px; font-weight: bold; color: darkgreen; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>RemotaSa√∫de ‚Äì Recepci√≥n BLE</h1>

  <button id="connect">Conectar al ESP32</button>
  <div id="status">Estado: desconectado</div>

  <h3>Datos en vivo</h3>
  <div id="data">‚Äì</div>

  <h3>Log</h3>
  <pre id="log"></pre>

<script>
const SERVICE_UUID_DATOS = "12345678-1234-5678-1234-56789abcdef0";
const CHAR_UUID_DATOS    = "12345678-1234-5678-1234-56789abcdef1";

const NUS_SERVICE_UUID   = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const NUS_CHAR_RX        = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

let logEl = document.getElementById("log");
let statusEl = document.getElementById("status");
let dataEl = document.getElementById("data");

function log(msg) {
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
  console.log(msg);
}

document.getElementById("connect").onclick = async () => {
  try {
    log("üîé Buscando dispositivo BLE...");
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "ESP32" }],
      optionalServices: [SERVICE_UUID_DATOS, NUS_SERVICE_UUID]
    });

    log("‚û°Ô∏è Dispositivo elegido: " + device.name);
    statusEl.textContent = "Estado: conectando...";

    const server = await device.gatt.connect();
    log("‚úÖ Conectado al GATT server");

    let service, characteristic;

    try {
      service = await server.getPrimaryService(SERVICE_UUID_DATOS);
      characteristic = await service.getCharacteristic(CHAR_UUID_DATOS);
      log("Usando servicio DATOS personalizado");
    } catch (e) {
      log("‚ö†Ô∏è Servicio DATOS no encontrado, probando NUS...");
      service = await server.getPrimaryService(NUS_SERVICE_UUID);
      characteristic = await service.getCharacteristic(NUS_CHAR_RX);
    }

    await characteristic.startNotifications();
    characteristic.addEventListener("characteristicvaluechanged", ev => {
      let val = new TextDecoder().decode(ev.target.value);
      log("Dato recibido: " + val);
      dataEl.textContent = val;
    });

    statusEl.textContent = "Estado: conectado";
    log("üì° Esperando notificaciones...");
  } catch (err) {
    log("‚ùå ERROR: " + err);
    statusEl.textContent = "Estado: error";
  }
};
</script>
</body>
</html>
